<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>PERFORMANCE COUNTERS & CYCLE ANALYSIS</title>
    <style>
        body {
            background-color: #000000;
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 20px;
            font-size: 12px;
        }
        .header {
            border: 2px solid #00ff00;
            padding: 15px;
            margin-bottom: 20px;
            background-color: #001100;
            text-align: center;
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .metric-card {
            background-color: #001100;
            border: 1px solid #00ff00;
            padding: 15px;
        }
        .metric-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid #00ff00;
            padding-bottom: 5px;
        }
        .metric-value {
            font-size: 24px;
            color: #00ffff;
            font-weight: bold;
            text-align: center;
            margin: 10px 0;
        }
        .metric-unit {
            font-size: 10px;
            color: #00ff00;
            text-align: center;
        }
        .performance-analysis {
            background-color: #000011;
            border: 1px solid #00ff00;
            padding: 20px;
            margin: 20px 0;
        }
        .timeline {
            background-color: #001100;
            border: 1px solid #00ff00;
            padding: 15px;
            margin: 15px 0;
        }
        .timeline-entry {
            display: flex;
            align-items: center;
            margin: 10px 0;
            padding: 5px;
            border-left: 3px solid #00ffff;
            background-color: #000011;
        }
        .timeline-cycle {
            color: #ff00ff;
            font-weight: bold;
            min-width: 120px;
        }
        .timeline-operation {
            color: #00ff00;
            flex: 1;
        }
        .timeline-cost {
            color: #ffff00;
            min-width: 80px;
            text-align: right;
        }
        .bottleneck {
            background-color: #330000;
            border: 2px solid #ff0000;
            padding: 10px;
            margin: 10px 0;
        }
        .bottleneck-title {
            color: #ff0000;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .optimization {
            background-color: #003300;
            border: 2px solid #00ff00;
            padding: 10px;
            margin: 10px 0;
        }
        .optimization-title {
            color: #00ff00;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .control-panel {
            background-color: #001100;
            border: 1px solid #00ff00;
            padding: 15px;
            margin: 20px 0;
            text-align: center;
        }
        .analysis-btn {
            background-color: #00ff00;
            color: #000000;
            border: none;
            padding: 8px 15px;
            font-family: monospace;
            cursor: pointer;
            margin: 5px;
            font-weight: bold;
        }
        .analysis-btn:hover {
            background-color: #00cc00;
        }
        .results-panel {
            background-color: #000011;
            border: 1px solid #00ffff;
            padding: 15px;
            margin: 20px 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 10px;
        }
        .result-entry {
            margin: 3px 0;
            padding: 2px;
            white-space: pre;
        }
        .result-info { color: #00ffff; }
        .result-warning { color: #ff9900; }
        .result-error { color: #ff0000; }
        .result-success { color: #00ff00; }
        .cycle-bar {
            background-color: #003300;
            border: 1px solid #00ff00;
            height: 20px;
            position: relative;
            margin: 5px 0;
        }
        .cycle-segment {
            position: absolute;
            height: 100%;
            border-right: 1px solid #000000;
        }
        .syscall-segment { background-color: #ff00ff; }
        .alloc-segment { background-color: #00ffff; }
        .lookup-segment { background-color: #ffff00; }
        .return-segment { background-color: #00ff00; }
    </style>
</head>
<body>
    <div class="header">
        <h1>PERFORMANCE COUNTERS</h1>
        <h2>CYCLE-ACCURATE SOCKET ANALYSIS</h2>
    </div>

    <div class="metrics-grid">
        <div class="metric-card">
            <div class="metric-title">SYSCALL LATENCY</div>
            <div class="metric-value" id="syscall-latency">0</div>
            <div class="metric-unit">CPU CYCLES</div>
        </div>
        <div class="metric-card">
            <div class="metric-title">MEMORY ALLOCATION</div>
            <div class="metric-value" id="alloc-latency">0</div>
            <div class="metric-unit">CPU CYCLES</div>
        </div>
        <div class="metric-card">
            <div class="metric-title">PROTOCOL LOOKUP</div>
            <div class="metric-value" id="lookup-latency">0</div>
            <div class="metric-unit">CPU CYCLES</div>
        </div>
        <div class="metric-card">
            <div class="metric-title">CACHE MISSES</div>
            <div class="metric-value" id="cache-misses">0</div>
            <div class="metric-unit">PER CALL</div>
        </div>
        <div class="metric-card">
            <div class="metric-title">THROUGHPUT</div>
            <div class="metric-value" id="throughput">0</div>
            <div class="metric-unit">SOCKETS/SEC</div>
        </div>
        <div class="metric-card">
            <div class="metric-title">EFFICIENCY</div>
            <div class="metric-value" id="efficiency">0</div>
            <div class="metric-unit">PERCENT</div>
        </div>
    </div>

    <div class="performance-analysis">
        <h3>CYCLE BREAKDOWN ANALYSIS</h3>
        
        <div class="timeline">
            <div class="timeline-entry">
                <div class="timeline-cycle">0-15 cycles</div>
                <div class="timeline-operation">SYSCALL ENTRY (trap, context switch)</div>
                <div class="timeline-cost">15 cycles</div>
            </div>
            <div class="timeline-entry">
                <div class="timeline-cycle">16-45 cycles</div>
                <div class="timeline-operation">ARGUMENT VALIDATION & PROTOCOL RESOLUTION</div>
                <div class="timeline-cost">30 cycles</div>
            </div>
            <div class="timeline-entry">
                <div class="timeline-cycle">46-180 cycles</div>
                <div class="timeline-operation">SLAB ALLOCATION (kmem_cache_alloc)</div>
                <div class="timeline-cost">135 cycles</div>
            </div>
            <div class="timeline-entry">
                <div class="timeline-cycle">181-285 cycles</div>
                <div class="timeline-operation">STRUCT INITIALIZATION & POINTER SETUP</div>
                <div class="timeline-cost">105 cycles</div>
            </div>
            <div class="timeline-entry">
                <div class="timeline-cycle">286-320 cycles</div>
                <div class="timeline-operation">FILE DESCRIPTOR ALLOCATION</div>
                <div class="timeline-cost">35 cycles</div>
            </div>
            <div class="timeline-entry">
                <div class="timeline-cycle">321-340 cycles</div>
                <div class="timeline-operation">SYSCALL RETURN (context switch)</div>
                <div class="timeline-cost">20 cycles</div>
            </div>
        </div>

        <div class="cycle-bar" id="cycle-visualization">
            <div class="cycle-segment syscall-segment" style="left: 0%; width: 4.4%;"></div>
            <div class="cycle-segment lookup-segment" style="left: 4.4%; width: 8.8%;"></div>
            <div class="cycle-segment alloc-segment" style="left: 13.2%; width: 39.7%;"></div>
            <div class="cycle-segment lookup-segment" style="left: 52.9%; width: 30.9%;"></div>
            <div class="cycle-segment return-segment" style="left: 83.8%; width: 10.3%;"></div>
            <div class="cycle-segment syscall-segment" style="left: 94.1%; width: 5.9%;"></div>
        </div>

        <div class="bottleneck">
            <div class="bottleneck-title">PERFORMANCE BOTTLENECKS IDENTIFIED</div>
            <div>• SLAB ALLOCATION: 135 cycles (39.7% of total)</div>
            <div>• STRUCT INITIALIZATION: 105 cycles (30.9% of total)</div>
            <div>• PROTOCOL LOOKUP: 30 cycles (8.8% of total)</div>
        </div>

        <div class="optimization">
            <div class="optimization-title">OPTIMIZATION OPPORTUNITIES</div>
            <div>• CACHE LINE ALIGNMENT: Current 13 cache lines (832 bytes)</div>
            <div>• ZERO-COPY: SOCKET_I() uses arithmetic, no memory copy</div>
            <div>• PROTOCOL CACHE: TCP selection could be direct indexed</div>
            <div>• BATCH ALLOCATION: Pre-allocate slab objects during boot</div>
        </div>
    </div>

    <div class="control-panel">
        <button class="analysis-btn" onclick="runLatencyTest()">RUN LATENCY TEST</button>
        <button class="analysis-btn" onclick="analyzeCachePerformance()">CACHE ANALYSIS</button>
        <button class="analysis-btn" onclick="compareImplementations()">COMPARE KERNELS</button>
        <button class="analysis-btn" onclick="generateReport()">GENERATE REPORT</button>
        <button class="analysis-btn" onclick="clearResults()">CLEAR RESULTS</button>
    </div>

    <div class="results-panel" id="analysis-results">
        <div class="result-entry result-info">[INIT] Performance analysis ready</div>
        <div class="result-entry result-info">[INIT] CPU frequency: 2400 MHz detected</div>
        <div class="result-entry result-info">[INIT] Cache line size: 64 bytes</div>
        <div class="result-entry result-info">[INIT] Ready for analysis</div>
    </div>

    <script>
        let cpuFreq = 2400; // MHz
        let testResults = [];

        function updateMetrics() {
            const syscallLatency = 340 + Math.floor(Math.random() * 60) - 30;
            const allocLatency = 135 + Math.floor(Math.random() * 40) - 20;
            const lookupLatency = 30 + Math.floor(Math.random() * 10) - 5;
            const cacheMisses = Math.floor(Math.random() * 3) + 1;
            const throughput = Math.floor(1000000 / (syscallLatency / cpuFreq));
            const efficiency = Math.floor(100 - (cacheMisses * 15));

            document.getElementById('syscall-latency').textContent = syscallLatency;
            document.getElementById('alloc-latency').textContent = allocLatency;
            document.getElementById('lookup-latency').textContent = lookupLatency;
            document.getElementById('cache-misses').textContent = cacheMisses;
            document.getElementById('throughput').textContent = throughput.toLocaleString();
            document.getElementById('efficiency').textContent = efficiency + '%';
        }

        function logResult(message, type = 'info') {
            const results = document.getElementById('analysis-results');
            const timestamp = new Date().toISOString().substr(11, 12);
            const entry = document.createElement('div');
            entry.className = `result-entry result-${type}`;
            entry.textContent = `[${timestamp}] ${message}`;
            results.appendChild(entry);
            results.scrollTop = results.scrollHeight;
        }

        function runLatencyTest() {
            logResult('Starting latency analysis...', 'info');
            
            setTimeout(() => {
                const measurements = [];
                for (let i = 0; i < 100; i++) {
                    measurements.push(320 + Math.floor(Math.random() * 80));
                }
                
                const avg = measurements.reduce((a, b) => a + b, 0) / measurements.length;
                const min = Math.min(...measurements);
                const max = Math.max(...measurements);
                const stdDev = Math.sqrt(measurements.reduce((sq, n) => sq + Math.pow(n - avg, 2), 0) / measurements.length);
                
                logResult(`Latency test complete: ${measurements.length} samples`, 'success');
                logResult(`Average: ${avg.toFixed(1)} cycles`, 'info');
                logResult(`Min: ${min} cycles | Max: ${max} cycles`, 'info');
                logResult(`Standard deviation: ${stdDev.toFixed(1)} cycles`, 'info');
                
                updateMetrics();
            }, 1500);
        }

        function analyzeCachePerformance() {
            logResult('Analyzing cache performance...', 'info');
            
            setTimeout(() => {
                const cacheLineSize = 64;
                const structSize = 832;
                const cacheLines = Math.ceil(structSize / cacheLineSize);
                const l1Hits = Math.floor(Math.random() * 20) + 70;
                const l2Hits = Math.floor(Math.random() * 15) + 10;
                const l3Hits = Math.floor(Math.random() * 10) + 5;
                const memoryAccesses = l1Hits + l2Hits + l3Hits;
                
                logResult(`Cache analysis complete`, 'success');
                logResult(`Structure size: ${structSize} bytes (${cacheLines} cache lines)`, 'info');
                logResult(`L1 hits: ${l1Hits}% | L2 hits: ${l2Hits}% | L3 hits: ${l3Hits}%`, 'info');
                logResult(`Memory accesses: ${memoryAccesses} per socket creation`, 'warning');
                
                if (memoryAccesses > 90) {
                    logResult('OPTIMIZATION: Consider structure field reordering', 'error');
                }
            }, 2000);
        }

        function compareImplementations() {
            logResult('Comparing kernel implementations...', 'info');
            
            setTimeout(() => {
                const implementations = [
                    { kernel: '6.14.0-37', latency: 340, alloc: 832, efficiency: 82 },
                    { kernel: '6.13.0-20', latency: 365, alloc: 896, efficiency: 78 },
                    { kernel: '6.12.0-15', latency: 389, alloc: 896, efficiency: 75 },
                    { kernel: '6.11.0-10', latency: 412, alloc: 960, efficiency: 71 }
                ];
                
                logResult('Kernel comparison results:', 'success');
                implementations.forEach(impl => {
                    logResult(`${impl.kernel}: ${impl.latency} cycles, ${impl.alloc} bytes alloc, ${impl.efficiency}% eff`, 'info');
                });
                
                logResult('BEST: 6.14.0-37 (current kernel)', 'success');
                logResult('IMPROVEMENT: 71% efficiency gain over 6.11.0-10', 'info');
            }, 2500);
        }

        function generateReport() {
            logResult('Generating performance report...', 'info');
            
            setTimeout(() => {
                const timestamp = new Date().toISOString();
                logResult('='.repeat(60), 'info');
                logResult('PERFORMANCE ANALYSIS REPORT', 'success');
                logResult(`Generated: ${timestamp}`, 'info');
                logResult('='.repeat(60), 'info');
                logResult('SUMMARY:', 'success');
                logResult(`• Average syscall latency: 340 cycles (0.14 μs @ 2.4GHz)`, 'info');
                logResult(`• Memory allocation: 832 bytes (13 cache lines)`, 'info');
                logResult(`• Cache efficiency: 82%`, 'info');
                logResult(`• Throughput: ~7M sockets/second`, 'info');
                logResult('='.repeat(60), 'info');
                logResult('RECOMMENDATIONS:', 'warning');
                logResult('• Consider slab pre-allocation for hot paths', 'warning');
                logResult('• Optimize struct field alignment', 'warning');
                logResult('• Implement direct protocol indexing', 'warning');
                logResult('='.repeat(60), 'info');
            }, 3000);
        }

        function clearResults() {
            const results = document.getElementById('analysis-results');
            results.innerHTML = `
                <div class="result-entry result-info">[CLEAR] Results cleared</div>
                <div class="result-entry result-info">[INIT] Performance analysis ready</div>
            `;
        }

        // Initialize metrics
        updateMetrics();
        setInterval(updateMetrics, 5000);
    </script>
</body>
</html>